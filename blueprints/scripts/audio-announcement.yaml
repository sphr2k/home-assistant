alias: Audio Announcement with Volume Restore
description: Reusable script for TTS announcements with volume control
fields:
  message:
    name: Message
    description: The message to speak
    required: true
    selector:
      text: {}
  language:
    name: Language
    description: Language for TTS
    example: de-DE
    selector:
      text: {}
  media_player:
    name: Media Player
    description: Media player entity to use
    example: media_player.homepod
    selector:
      entity:
        domain: media_player
  service:
    name: TTS Service
    example: tts.google_cloud
    selector:
      entity:
        domain: tts
  volume:
    name: TTS Volume
    description: Volume level for TTS
    example: 0.7
    selector:
      number:
        min: 0
        max: 1
        step: 0.05

sequence:
  - variables:
      default_language: de-DE
      default_media_player: media_player.homepod
      default_tts_volume: 0.7
      default_tts_service: tts.google_cloud
      default_restore_volume: 0.6

      media_player_target: "{{ media_player | default(default_media_player) }}"
      language_target: "{{ language | default(default_language) }}"
      tts_service_target: "{{ service | default(default_tts_service) }}"
      tts_volume_target: "{{ (volume if volume is not none else default_tts_volume) | float }}"

      restore_volume: >-
        {{ state_attr(media_player_target, 'volume_level')
           | default(default_restore_volume)
           | float(default_restore_volume) }}

  - action: remote.turn_on
    target:
      entity_id: remote.homepod

  - action: media_player.volume_set
    target:
      entity_id: "{{ media_player_target }}"
    data:
      volume_level: "{{ tts_volume_target }}"

  - action: tts.speak
    target:
      entity_id: "{{ tts_service_target }}"
    data:
      cache: true
      media_player_entity_id: "{{ media_player_target }}"
      message: "{{ message }}"
      language: "{{ language_target }}"

  - action: media_player.volume_set
    target:
      entity_id: "{{ media_player_target }}"
    data:
      volume_level: "{{ restore_volume }}"

mode: single
